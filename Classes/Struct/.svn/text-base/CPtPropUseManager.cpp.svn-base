//
//  CPtPropUseManager.cpp
//  91.cube
//
//  Created by phileas on 13-10-29.
//
//

#include "CPtPropUseManager.h"
#include "gameConfig.h"
#include "gameTools.h"
CPtPropUserManager * CPtPropUserManager::s_pInstance = NULL;

CPtPropUserManager * CPtPropUserManager::getInstance()
{
    if (!s_pInstance)
    {
        s_pInstance = new CPtPropUserManager();
    }
    return s_pInstance;
}

void CPtPropUserManager::releaseManager()
{
    CC_SAFE_DELETE(s_pInstance);
    s_pInstance = NULL;
}

CPtPropUserManager::CPtPropUserManager()
{
    m_pPlayer = SinglePlayer::instance();
    loadDataFromFile();
}

CPtPropUserManager::~CPtPropUserManager()
{
}

vector<int>* CPtPropUserManager::getUserPropsBy(USERTYPE inUserType)
{
    map< USERTYPE, vector<int> >::iterator it  = m_cUserPropContainer.find(inUserType);
    if (it != m_cUserPropContainer.end())
    {
        return &it->second;
    }else
    {
        return NULL;
    }
}

/*
 * @breif 获取当前背包中有道具ID，若没有则返回 －1
 */
int CPtPropUserManager::getGetHavePropIdByFunctionId(USERTYPE inUserType)
{
    int nRet = -1;
    map< USERTYPE, vector<int> >::iterator it  = m_cUserPropContainer.find(inUserType);
    if (it != m_cUserPropContainer.end())
    {
        const vector<int> & rVector = it->second;
        for (int i  = 0; i < rVector.size(); i++)
        {
            nRet = m_pPlayer->getPropCountFromBag(rVector[i]);
            if (nRet!= 0)
            {
                nRet = rVector[i];
                break;
            }else
            {
                nRet = -1;
            }
        }
    }

    return nRet;
}

/*
 * @breif 返回可供选择道具列表中的第一个
 */
int CPtPropUserManager::getFirstPropIdByFunctionId(USERTYPE inUserType)
{
    int nRet = -1;
    map< USERTYPE, vector<int> >::iterator it  = m_cUserPropContainer.find(inUserType);
    if (it != m_cUserPropContainer.end())
    {
        const vector<int> & rVector = it->second;
        if (rVector.size() > 0)
        {
            nRet = rVector[0];
        }
    }
    return nRet;
}

void CPtPropUserManager::loadDataFromFile()
{
    CCDictionary * tmp = CCDictionary::createWithContentsOfFile(CSTR_FILEPTAH(resRootPath, "function.plist"));
    CCAssert(tmp, "no have the file : function.plist");
    CCDictElement *element = NULL;
    CCDictionary *elementDict = NULL;
    CCDICT_FOREACH(tmp, element)
    {
        elementDict = (CCDictionary*) element->getObject();
        USERTYPE id = (USERTYPE) GameTools::intForKey("id", elementDict);
        if (id != NONE)
        {
            int  value = 0;
            char buffer[30] = {0};
            vector<int > props;
            for (int i = 1; i < 6; i++)
            {
                sprintf(buffer, "item_id_%d", i);
                value  = GameTools::intForKey(buffer, elementDict);
                if (value != 0)
                {
                    props.push_back(value);
                }
            }
            props.reserve(props.size());
            m_cUserPropContainer.insert(make_pair(id, props));
        }
    }
}